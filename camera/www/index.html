<!DOCTYPE html>
<html lang="en">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Cupolen Camera Controller</title>
<style>
    html {
        margin: 0;
    }

    body {
        margin: 0;
        padding: 20px 20px 0px 20px;
        background: #373234;
        background: -webkit-radial-gradient(circle at center, #373234, #222222);
        background: -moz-radial-gradient(circle at center, #373234, #222222);
        background: radial-gradient(ellipse at center, #373234, #222222);
    }

    hr {
        margin: 0, 0, 0, 0;
        border: 1px solid rgb(77, 50, 90);
    }

    div {
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
    }

    .headingFrame {
        border: 1px solid black;
        border-radius: 6px;
        margin-bottom: 50px;
        max-height: 250px;
        max-width: 1450px
    }

    .headingFrameLast {
        margin-bottom: 0px;
    }

    .panelFrame {
        display: flex;
        border: 0px solid #DDDDDD;
    }

    .joystickFrame {
        position: relative;
        margin-top: 20px;
        border: 0px solid #fcc600;
        width: 250px;
        min-width: 180px;
        height: 200px;
        overflow: visible;
    }

    .zoomFrame {
        border: 0px solid #fcc600;
        width: 80px;
    }

    .irisFrame {
        border: 0px solid #fcc600;
        width: 80px;
    }

    .fokusFrame {
        border: 0px solid #fcc600;
        width: 150px;
        min-width: 150px;
    }

    .presetFrame {
        max-height: 230px;
        max-width: 900px;
        overflow: auto;
    }

    .heading {
        font-family: Arial, Helvetica, sans-serif;
        font-size: 20px;
        font-weight: 100;
        text-shadow: 1px 1px 20px #000000;
        color: #DDDDDD;
        margin-top: -12px;
        margin-bottom: -12px;
        margin-left: 12px;
    }

    .subHeadingText {
        font-family: Arial, Helvetica, sans-serif;
        font-size: 16px;
        font-weight: 100;
        text-align: center;
        padding: 15px 0 0px 0;
        margin: 0px;
        text-shadow: 1px 1px 20px #000000;
        text-decoration: none;
        display: inline-block;
        cursor: pointer;
        color: #DDDDDD;
        width: 100%
    }

    .buttonDiv {
        font-family: Arial, Helvetica, sans-serif;
        font-size: 20px;
        font-weight: 100;
        text-shadow: 1px 1px 20px #000000;
        color: #DDDDDD;
        overflow: hidden;
        max-height: 66px;
    }

    .buttonLink {
        -webkit-border-radius: 10px;
        -moz-border-radius: 10px;
        border-radius: 6px;
        border-color: #000000;
        border-width: 1px;
        border-style: double;
        font-family: Arial, Helvetica, sans-serif;
        font-size: 20px;
        font-weight: 100;
        text-align: center;
        padding: 10px;
        width: 30px;
        height: 26px;
        vertical-align: top;
        margin: 10px 10px 10px 10px;
        box-shadow: 1px 1px 10px 0 #000000;
        -webkit-box-shadow: 1px 1px 10px 0 #000000;
        -moz-box-shadow: 1px 1px 10px 0 #000000;
        text-shadow: 1px 1px 20px #000000;
        text-decoration: none;
        display: inline-block;
        cursor: pointer;
        color: #DDDDDD;
    }

    .buttonLink:active {
        border-color: #EEEEEE;
    }

    .presetDiv {
        font-family: Arial, Helvetica, sans-serif;
        font-size: 20px;
        font-weight: 100;
        text-shadow: 1px 1px 20px #000000;
        color: #DDDDDD;
        overflow: hidden;
    }

    .presetLink {
        -webkit-border-radius: 10px;
        -moz-border-radius: 10px;
        border-radius: 6px;
        border-color: #000000;
        border-width: 1px;
        border-style: double;
        font-family: Arial, Helvetica, sans-serif;
        font-size: 20px;
        font-weight: 100;
        text-align: center;
        vertical-align: top;
        padding: 10px;
        width: 150px;
        height: 73px;
        margin: 10px 10px 10px 10px;
        box-shadow: 1px 1px 10px 0 #000000;
        -webkit-box-shadow: 1px 1px 10px 0 #000000;
        -moz-box-shadow: 1px 1px 10px 0 #000000;
        text-shadow: 1px 1px 20px #000000;
        text-decoration: none;
        display: inline-block;
        cursor: pointer;
        color: #DDDDDD;
    }

    .presetLink:active {
         border-color: #EEEEEE;
    }

    .horizontalSpace {
        width: 15px;
        display: inline-block;
    }

    .copyright {
        color: #DDDDDD;
        position: absolute;
        bottom: 10px;
        right: 10px;
    }

    @keyframes blink {
        50% { border-color: #fcc600; }
    }

    .blinkFrame {
        animation: blink .5s step-end infinite alternate;
    }

    .markFrame {
        border-color: #EEEEEE;
    }
    
    .selectFrame {
        border-color: #fcc600;
    }
</style>
</head>
<body>
<span class="copyright">Cupolen Camera Controller v 0.2</span>

<fieldset id="control-1" class="headingFrame">
    <legend class="heading">Camera 1</legend>
    <div id="controlPanel-1" class="panelFrame">
        <div id="joystick-1" class="joystickFrame"></div>
        <div class="horizontalSpace"></div>
        <div class="zoomFrame">
            <div class="subHeadingText">Zoom<hr></div>
            <div class="buttonDiv"><div id="zoom-In-1" class="buttonLink">&#8593;</div></div>
            <div class="buttonDiv"><div id="zoom-Out-1" class="buttonLink">&#8595;</div></div>
        </div>
        <div class="horizontalSpace"></div>
        <div class="fokusFrame">
            <div class="subHeadingText">Fokus<hr></div>
            <div class="buttonDiv">
                <div id="focus-Auto-1" class="buttonLink">A</div>
                <div id="focus-Near-1" class="buttonLink">&#8593;</div>
            </div>
            <div class="buttonDiv">
                <div id="focus-Manual-1" class="buttonLink">M</div>
                <div id="focus-Far-1" class="buttonLink">&#8595;</div>
            </div>
        </div>
        <div class="horizontalSpace"></div>
        <div class="irisFrame">
            <div class="subHeadingText">Iris<hr></div>
            <div class="buttonDiv"><div id="iris-Up-1" class="buttonLink">&#8593;</div></div>
            <div class="buttonDiv"><div id="iris-Down-1" class="buttonLink">&#8595;</div></div>
        </div>
        <div class="horizontalSpace"></div>
        <div class="presetFrame">
            <div class="presetDiv">
                <div id="preset-10" class="presetLink">Store</div>
                <div id="preset-11" class="presetLink">1</div>
                <div id="preset-12" class="presetLink">2</div>
                <div id="preset-13" class="presetLink">3</div>
                <div id="preset-14" class="presetLink">4</div>
                <div id="preset-15" class="presetLink">5</div>
                <div id="preset-16" class="presetLink">6</div>
                <div id="preset-17" class="presetLink">7</div>
            </div>
        </div>
    </div>
</fieldset>

<fieldset id="control-2" class="headingFrame">
    <legend class="heading">Camera 2</legend>
    <div id="controlPanel-2" class="panelFrame">
        <div id="joystick-2" class="joystickFrame"></div>
        <div class="horizontalSpace"></div>
        <div class="zoomFrame">
            <div class="subHeadingText">Zoom<hr></div>
            <div class="buttonDiv"><div id="zoom-In-2" class="buttonLink">&#8593;</div></div>
            <div class="buttonDiv"><div id="zoom-Out-2" class="buttonLink">&#8595;</div></div>
        </div>
        <div class="horizontalSpace"></div>
        <div class="fokusFrame">
            <div class="subHeadingText">Fokus<hr></div>
            <div class="buttonDiv">
                <div id="focus-Auto-2" class="buttonLink">A</div>
                <div id="focus-Near-2" class="buttonLink">&#8593;</div>
            </div>
            <div class="buttonDiv">
                <div id="focus-Manual-2" class="buttonLink">M</div>
                <div id="focus-Far-2" class="buttonLink">&#8595;</div>
            </div>
        </div>
        <div class="horizontalSpace"></div>
        <div class="irisFrame">
            <div class="subHeadingText">Iris<hr></div>
            <div class="buttonDiv"><div id="iris-Up-2" class="buttonLink">&#8593;</div></div>
            <div class="buttonDiv"><div id="iris-Down-2" class="buttonLink">&#8595;</div></div>
        </div>
        <div class="horizontalSpace"></div>
        <div class="presetFrame">
            <div class="presetDiv">
                <div id="preset-20" class="presetLink">Store</div>
                <div id="preset-21" class="presetLink">1</div>
                <div id="preset-22" class="presetLink">2</div>
                <div id="preset-23" class="presetLink">3</div>
                <div id="preset-24" class="presetLink">4</div>
                <div id="preset-25" class="presetLink">5</div>
                <div id="preset-26" class="presetLink">6</div>
                <div id="preset-27" class="presetLink">7</div>
            </div>
        </div>
    </div>
</fieldset>

<fieldset id="control-3" class="headingFrame headingFrameLast">
    <legend class="heading">Camera 3</legend>
    <div id="controlPanel-3" class="panelFrame">
        <div id="joystick-3" class="joystickFrame"></div>
        <div class="horizontalSpace"></div>
        <div class="zoomFrame">
            <div class="subHeadingText">Zoom<hr></div>
            <div class="buttonDiv"><div id="zoom-In-3" class="buttonLink">&#8593;</div></div>
            <div class="buttonDiv"><div id="zoom-Out-3" class="buttonLink">&#8595;</div></div>
        </div>
        <div class="horizontalSpace"></div>
        <div class="fokusFrame">
            <div class="subHeadingText">Fokus<hr></div>
            <div class="buttonDiv">
                <div id="focus-Auto-3" class="buttonLink">A</div>
                <div id="focus-Near-3" class="buttonLink">&#8593;</div>
            </div>
            <div class="buttonDiv">
                <div id="focus-Manual-3" class="buttonLink">M</div>
                <div id="focus-Far-3" class="buttonLink">&#8595;</div>
            </div>
        </div>
        <div class="horizontalSpace"></div>
        <div class="irisFrame">
            <div class="subHeadingText">Iris<hr></div>
            <div class="buttonDiv"><div id="iris-Up-3" class="buttonLink">&#8593;</div></div>
            <div class="buttonDiv"><div id="iris-Down-3" class="buttonLink">&#8595;</div></div>
        </div>
        <div class="horizontalSpace"></div>
        <div class="presetFrame">
            <div class="presetDiv">
                <div id="preset-30" class="presetLink">Store</div>
                <div id="preset-31" class="presetLink">1</div>
                <div id="preset-32" class="presetLink">2</div>
                <div id="preset-33" class="presetLink">3</div>
                <div id="preset-34" class="presetLink">4</div>
                <div id="preset-35" class="presetLink">5</div>
                <div id="preset-36" class="presetLink">6</div>
                <div id="preset-37" class="presetLink">7</div>
            </div>
        </div>
    </div>
</fieldset>

<script src="nipplejs.js"></script>
<script>
    const DEBUG = 1;
    const MAX_PRESETS = 7;
    const PAN_SPEED = 0x12;
    const TILT_SPEED = 0x12;
    const ZOOM_SPEED = 0x7;

    let joystickDiameter = 180;
    let isStoreSelected = [false,false,false,false];
    let selectedPreset = [0,0,0,0];
    let focusMode = [[0,0,0,0,0,0,0,0], [0,0,0,0,0,0,0,0], [0,0,0,0,0,0,0,0], [0,0,0,0,0,0,0,0]];
    let previousPanCmd = ["", "", "", ""];

    // CMD_PTZ_POSITION parameters: 0=presetNr
    const CMD_PTZ_POSITION_SET = "81 01 04 3F 01 0{0} FF";
    const CMD_PTZ_POSITION_RECALL = "81 01 04 3F 02 0{0} FF";

    // CMD_PTZ_PAN parameters: 0=PanSpeed [1-12h]; 1=TiltSpeed [1-12h]
    const CMD_PTZ_PAN_UP = "81 01 06 01 {0} {1} 03 01 FF";
    const CMD_PTZ_PAN_DOWN = "81 01 06 01 {0} {1} 03 02 FF";
    const CMD_PTZ_PAN_LEFT = "81 01 06 01 {0} {1} 01 03 FF";
    const CMD_PTZ_PAN_RIGHT = "81 01 06 01 {0} {1} 02 03 FF";
    const CMD_PTZ_PAN_UP_LEFT = "81 01 06 01 {0} {1} 01 01 FF";
    const CMD_PTZ_PAN_UP_RIGHT = "81 01 06 01 {0} {1} 02 01 FF";
    const CMD_PTZ_PAN_DOWN_LEFT = "81 01 06 01 {0} {1} 01 02 FF";
    const CMD_PTZ_PAN_DOWN_RIGHT = "81 01 06 01 {0} {1} 02 02 FF";
    const CMD_PTZ_PAN_STOP = "81 01 06 01 {0} {1} 03 03 FF";
    const CMD_PTZ_PAN_HOME = "81 01 06 04 FF";

    // CMD_PTZ_ZOOM parameters: 0=ZoomSpeed [0-7, where 7 is fast]
    const CMD_PTZ_ZOOM_IN = "81 01 04 07 2{0} FF";
    const CMD_PTZ_ZOOM_OUT = "81 01 04 07 3{0} FF";
    const CMD_PTZ_ZOOM_STOP = "81 01 04 07 00 FF";

    // CMD_PTZ_FOCUS have no parameters
    const CMD_PTZ_FOCUS_AUTO = "81 01 04 38 02 FF";
    const CMD_PTZ_FOCUS_MANUAL = "81 01 04 38 03 FF";
    const CMD_PTZ_FOCUS_FAR = "81 01 04 08 02 FF";
    const CMD_PTZ_FOCUS_NEAR = "81 01 04 08 03 FF";
    const CMD_PTZ_FOCUS_STOP = "81 01 04 08 00 FF";
    
    // CMD_PTZ_IRIS have no parameters
    const CMD_PTZ_IRIS_UP = "81 01 04 0B 02 FF";
    const CMD_PTZ_IRIS_DOWN = "81 01 04 0B 03 FF";


    String.prototype.format = function() {
        let a = this;
        for (let k in arguments) {
            a = a.replace("{" + k + "}", arguments[k])
        }
        return a
    };

    String.prototype.stripAllSpaces = function() {
        let a = this;
        return a.replace(/\s+/g, '')
    }

    function debug(s) {
        if (DEBUG !== 0) console.log(s);
    }

    function adaptToWindowSize() {
        joystickDiameter = Math.min(180, (window.innerHeight / 4)-30); // Global var, used in scrips below
        let controlPanelHeight = Math.min(250, window.innerHeight / 4);
        let hasControlPanelMaxSize = (controlPanelHeight > 240);
        let marginBottom = 0;
        if (!hasControlPanelMaxSize) {
            for (let camNr = 1; camNr <=3; camNr++) {
                let element = document.getElementById("controlPanel-" + camNr);
                element.style.height = controlPanelHeight+"px";
                element = document.getElementById("control-" + camNr);
                element.style.margin = marginBottom + "px";
                element = document.getElementById("joystick-" + camNr);
                element.style.width = joystickDiameter + "px";
                element.style.height = joystickDiameter + "px";
            
                for (let presetNr = 0; presetNr <= MAX_PRESETS; presetNr++) {
                    let element = document.getElementById("preset-" + camNr + "" + presetNr);
                    let w = Math.min(150, (window.innerHeight / 8)-30);
                    let h = Math.min(73, (controlPanelHeight / 2)-40);
                    
                    element.style.width = w + "px";
                    element.style.height = h + "px";
                }
            }
        }
    }
    
    function updatePresetBorders(camNr) {
        for (let presetNr = 0; presetNr <= MAX_PRESETS; presetNr++) {
            let element = document.getElementById("preset-" + camNr + "" + presetNr);
            if (element === undefined) continue;

            let className = "";
            if (isStoreSelected[camNr]) {
                if (presetNr === 0) {
                    className = "markFrame";
                } else {
                    className = "blinkFrame";
                }
            } else if ((presetNr > 0) && (presetNr === selectedPreset[camNr])) {
                className = "markFrame";
            }
            element.className = "presetLink " + className;
        }
    }

    function updateFocusMode(camNr) {
        let mode = focusMode[camNr][selectedPreset[camNr]];
        let autoFocusElement = document.getElementById("focus-Auto-"+camNr);
        let manualFocusElement = document.getElementById("focus-Manual-"+camNr);
        if (autoFocusElement === undefined) return;
        if (manualFocusElement === undefined) return;

        if (mode === 0) {
            autoFocusElement.className = "buttonLink";
            manualFocusElement.className = "buttonLink";
        } else if (mode === 1) {
            autoFocusElement.className = "buttonLink markFrame";
            manualFocusElement.className = "buttonLink";
        } else {
            autoFocusElement.className = "buttonLink";
            manualFocusElement.className = "buttonLink markFrame";
        }
    }

    function clearSelectedPreset(camNr) {
        selectedPreset[camNr] = 0;
        updatePresetBorders(camNr);
    }

    function sendCameraCommand(camNr, cmdBytes) {
        return sendCommand(camNr, cmdBytes, "sendCameraCommand.php/", false);
    }

    function sendCommand(camNr, cmdBytes, url, handleResponse) {
        let cmd = cmdBytes.toString().stripAllSpaces();
        let cmdLength = 2 + cmd.length / 2; // 2 bytes length indicator. Div by 2 due to 2 chars per byte in string
        let lengthHeader = ((cmdLength < 0x10) ? "000" : "00") + cmdLength.toString(16); // 1 or 2 hex digits
        let httpData = "camNr=" + camNr + "&cmd=" + lengthHeader + cmd;
        let http = new XMLHttpRequest();
        http.open("POST", url, true);
        http.setRequestHeader("Content-type","application/x-www-form-urlencoded");
        //debug("sendCommand " + httpData + " to url " + url);
        http.send(httpData);
        if (handleResponse) {
            http.onload = function() {
                //applyStatus(http.responseText);
                //debug("handle response: " + http.responseText);
            };
        } else {
            http.onload = function() {
                //debug("skip response: " + http.responseText);
            };
        }
    }

    function ptzPan(camNr, panCmd, panSpeed, tiltSpeed)
    {
        clearSelectedPreset(camNr);
        let newPanCmd = panCmd.format(panSpeed, tiltSpeed);
        if (newPanCmd != previousPanCmd[camNr]) {
            debug("PanTilt " + camNr);
            previousPanCmd[camNr] = newPanCmd;
            sendCameraCommand(camNr, newPanCmd);
        }
    }

    function ptzPanStop(camNr)
    {
        debug("Pan stop " + camNr);
        previousPanCmd[camNr] = "";
        sendCameraCommand(camNr, CMD_PTZ_PAN_STOP.format(PAN_SPEED, TILT_SPEED));
    }

    function ptzPanHome(camNr)
    {
        debug("Pan home " + camNr);
        sendCameraCommand(camNr, CMD_PTZ_PAN_HOME);
    }

    function ptzZoomIn(camNr)
    {
        debug("Zoom In " + camNr);
        clearSelectedPreset(camNr);
        sendCameraCommand(camNr, CMD_PTZ_ZOOM_IN.format(ZOOM_SPEED));
    }

    function ptzZoomOut(camNr)
    {
        debug("Zoom Out " + camNr);
        clearSelectedPreset(camNr);
        sendCameraCommand(camNr, CMD_PTZ_ZOOM_OUT.format(ZOOM_SPEED));
    }

    function ptzZoomStop(camNr)
    {
        debug("Zoom Stop " + camNr);
        sendCameraCommand(camNr, CMD_PTZ_ZOOM_STOP);
    }

    function ptzFocusAuto(camNr)
    {
        debug("Auto focus " + camNr);
        clearSelectedPreset(camNr);
        focusMode[camNr][0] = 1;
        updateFocusMode(camNr);
        sendCameraCommand(camNr, CMD_PTZ_FOCUS_AUTO);
    }

    function ptzFocusManual(camNr)
    {
        debug("Manual focus " + camNr);
        clearSelectedPreset(camNr);
        focusMode[camNr][0] = 2;
        updateFocusMode(camNr);
        sendCameraCommand(camNr, CMD_PTZ_FOCUS_MANUAL);
    }

    function ptzFocusNear(camNr)
    {
        debug("Focus Near " + camNr);
        if (focusMode[camNr][0] === 0) {
            ptzFocusManual(camNr);
        }
        clearSelectedPreset(camNr);
        sendCameraCommand(camNr, CMD_PTZ_FOCUS_NEAR);
    }

    function ptzFocusFar(camNr)
    {
        debug("Focus Far " + camNr);
        if (focusMode[camNr][0] === 0) {
            ptzFocusManual(camNr);
        }
        clearSelectedPreset(camNr);
        sendCameraCommand(camNr, CMD_PTZ_FOCUS_FAR);
    }

    function ptzFocusStop(camNr)
    {
        debug("Focus Stop " + camNr);
        sendCameraCommand(camNr, CMD_PTZ_FOCUS_STOP);
    }


    function ptzIrisUp(camNr)
    {
        debug("Iris Up " + camNr);
        clearSelectedPreset(camNr);
        sendCameraCommand(camNr, CMD_PTZ_IRIS_UP);
    }

    function ptzIrisDown(camNr)
    {
        debug("Iris Down " + camNr);
        clearSelectedPreset(camNr);
        sendCameraCommand(camNr, CMD_PTZ_IRIS_DOWN);
    }

    function sendStorePreset(camNr, presetNr) {
        debug("Store pos for " + camNr + " to preset " + presetNr);
        sendCameraCommand(camNr, CMD_PTZ_POSITION_SET.format(presetNr));
    }

    function sendRecallPreset(camNr, presetNr) {
        debug("Recall pos for " + camNr + " to preset " + presetNr);
        sendCameraCommand(camNr, CMD_PTZ_POSITION_RECALL.format(presetNr));
    }

    function presetClicked(camNr, presetNr)
    {
        selectedPreset[camNr] = presetNr;
        if (isStoreSelected[camNr]) {
            isStoreSelected[camNr] = false;
            focusMode[camNr][presetNr] = focusMode[camNr][0];
            sendStorePreset(camNr, presetNr);
        } else {
            focusMode[camNr][0] = focusMode[camNr][presetNr];
            sendRecallPreset(camNr, presetNr);
        }
        updatePresetBorders(camNr);
        updateFocusMode(camNr);
    }

    function storeClicked(camNr)
    {
        isStoreSelected[camNr] = !isStoreSelected[camNr]; // Toggle
        updatePresetBorders(camNr);
    }


    // Register event listeners
    for (let camNr = 1; camNr <= 3; camNr++)
    {
        element = document.getElementById("zoom-In-" + camNr);
        element.addEventListener('mousedown', () => { ptzZoomIn(camNr); });
        element.addEventListener('mouseup', () => { ptzZoomStop(camNr); });

        element = document.getElementById("zoom-Out-" + camNr);
        element.addEventListener('mousedown', () => { ptzZoomOut(camNr, 1, 1); });
        element.addEventListener('mouseup', () => { ptzZoomStop(camNr); });

        element = document.getElementById("focus-Auto-" + camNr);
        element.addEventListener('click', () => { ptzFocusAuto(camNr); });

        element = document.getElementById("focus-Manual-" + camNr);
        element.addEventListener('click', () => { ptzFocusManual(camNr); });
        
        element = document.getElementById("focus-Near-" + camNr);
        element.addEventListener('mousedown', () => { ptzFocusNear(camNr); });
        element.addEventListener('mouseup', () => { ptzFocusStop(camNr); });

        element = document.getElementById("focus-Far-" + camNr);
        element.addEventListener('mousedown', () => { ptzFocusFar(camNr); });
        element.addEventListener('mouseup', () => { ptzFocusStop(camNr); });
        
        element = document.getElementById("iris-Up-" + camNr);
        element.addEventListener('click', () => { ptzIrisUp(camNr); });
        
        element = document.getElementById("iris-Down-" + camNr);
        element.addEventListener('click', () => { ptzIrisDown(camNr); });
        
        element = document.getElementById("preset-" + camNr + "0");
        element.addEventListener('click', () => { storeClicked(camNr); });
        
        for (let presetNr = 1; presetNr <= MAX_PRESETS; presetNr++) {
            element = document.getElementById("preset-" + camNr + "" + presetNr);
            element.addEventListener('click', () => { presetClicked(camNr, presetNr); });
        }
    }
    
    function dump(s) { console.log(s); }
    function createJoystick(elementName) {
        return nipplejs.create({
                                zone: document.getElementById(elementName),
                                mode: 'static',
                                position: { left: '50%', top: '50%' },
                                color: 'rgb(167, 120, 160)',
                                size: joystickDiameter
                                });
    }

    function bindJoystickEvents (joystick, camNr) {
                joystick.on('end', function (evt, data) {
                    //debug(data);
                    ptzPanStop(data.id + 1);
                }).on('move', function (evt, data) {
                    //debug(data);
                    let camNr = data.instance.id + 1; 
                    let panCmd = getPanCmdFromAngle(data.angle.degree);
                    let panSpeed = getPanSpeedFromDistance(data.distance);
                    let tiltSpeed = panSpeed;
                    if (panSpeed !== "00") ptzPan(camNr, panCmd, panSpeed, tiltSpeed);
                });
    }

    function getPanCmdFromAngle(angle) {
        const offset = 22.5;
        const angleDirMap = [   
            [ 0 + offset, CMD_PTZ_PAN_RIGHT ], 
            [ 45 + offset, CMD_PTZ_PAN_UP_RIGHT ], 
            [ 90 + offset, CMD_PTZ_PAN_UP ],
            [ 135 + offset, CMD_PTZ_PAN_UP_LEFT ], 
            [ 180 + offset, CMD_PTZ_PAN_LEFT ], 
            [ 225 + offset, CMD_PTZ_PAN_DOWN_LEFT ], 
            [ 270 + offset, CMD_PTZ_PAN_DOWN ],
            [ 315 + offset, CMD_PTZ_PAN_DOWN_RIGHT ]
        ];
        let direction = CMD_PTZ_PAN_RIGHT;
        for (let [a, d] of angleDirMap) {
            if (angle > a) continue;
            direction = d;
            break;
        }
        return direction;
    }
    
    function getPanSpeedFromDistance(distance) {
         // Use 0 speed up to distance 2, max speed for distance over 70 pixels. 2 digits in uppercase.
         if (distance <= 5) return "00";
         return ("0" + Math.min(PAN_SPEED, Math.round((distance / 70.0) * PAN_SPEED)).toString(16)).slice(-2).toUpperCase();
    }

    adaptToWindowSize();
    var joystick1 = createJoystick('joystick-1', 1);
    var joystick2 = createJoystick('joystick-2', 2);
    var joystick3 = createJoystick('joystick-3', 3);
    
    bindJoystickEvents(joystick1);
    bindJoystickEvents(joystick2);
    bindJoystickEvents(joystick3);
</script>
</body>
</html>
